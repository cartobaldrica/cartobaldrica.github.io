<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="title" content="Oregon Water Project Inventory">
    <meta name="description" content="Database of recent water-related research projects coducted at Oregon's public universities.">
    <meta name="image" content="img/year-of-water.png">
    <meta name="author" content="Institute for Natural Resources">

    <meta property="og:title" content="Oregon Water Project Inventory">
    <meta property="og:description" content="Database of recent water-related research projects coducted at Oregon's public universities.">
    <meta property="og:image" content="img/year-of-water.png">
    <meta property="og:author" content="Institute for Natural Resources">

    <meta property="twitter:title" content="Oregon Water Project Inventory">
    <meta property="twitter:description" content="Database of recent water-related research projects coducted at Oregon's public universities.">
    <meta property="twitter:image" content="img/year-of-water.png">
    <meta property="twitter:author" content="Institute for Natural Resources">

    <title>Year of Water</title>

	<link rel="shortcut icon" href="img/oregon.ico" type="image/x-icon">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.2/dist/leaflet.css" /> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="css/perfect-scrollbar.css" />

    <!-- Custom CSS -->
    <link href="css/year-of-water.css" rel="stylesheet">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Catamaran&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Mukta:300,400,700&display=swap" rel="stylesheet">



    <!-- jQuery -->
    <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://unpkg.com/papaparse@4.3.6/papaparse.min.js"></script>
    <script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.3.1/leaflet-omnivore.min.js'></script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>
    <script src="js/perfect-scrollbar.js"></script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body>
    
    <nav class="navbar navbar-expand-lg" id="nav" style="border-bottom:2px solid black;">
        <a id="backButton" href="year_of_water.html">Back</a>
        <div style="display:block; text-align:center;">
            <a href="year_of_water.html"><img src="img/year-of-water.png" style="height:100px; display:inline-block; vertical-align:top;"></a>
            <h3 style="display:inline-block;">Oregon Water <br/> Project Inventory</h3>
        </div>
    </nav>

    <div class="row" style="margin-bottom: 20px; height:100%; ">
        <div id="searchBar" style="padding-bottom:5px;">
            <input id="search" list="searchList" type="text" placeholder="Search For a Project..." style="margin-left:10px;">
            <button id="advSearch" style="margin-left:5px;" onclick="advSearch()">Advanced Search</button>
            <button id="advSearch" style="float:right;" onclick="clearSearch()">Clear Search</button>
            <div id="advancedSearch" style="display:none; margin-bottom:5px;">
                <div style="display:inline-block; padding-left:15px; padding-top:10px; color:black;">
                    <input type="checkbox" id="environment_check" name="environment" value="environment" onclick="themeClick('Environment','#environment_check','theme')">
                    <label for="environment">Environment</label><br>
                    <input type="checkbox" id="health_check" name="health" value="health" onclick="themeClick('Health','#health_check','theme')">
                    <label for="health">Health</label><br>
                    <input type="checkbox" id="safety_check" name="safety" value="safety" onclick="themeClick('Safety','#safety_check','theme')">
                    <label for="environment">Safety</label><br>
                    <input type="checkbox" id="economy_check" name="economy" value="economy" onclick="themeClick('Economy','#economy_check','theme')">
                    <label for="environment">Economy</label><br>
                    <input type="checkbox" id="arts_check" name="arts" value="arts" onclick="themeClick('Arts','#arts_check','theme')">
                    <label for="arts">Arts & Culture</label><br>
                    <input type="checkbox" id="comm_check" name="tech" value="tech" onclick="themeClick('Comm','#comm_check','theme')">
                    <label for="tech">Community</label><br>
                    <input type="checkbox" id="law_check" name="tech" value="tech" onclick="themeClick('Law','#law_check','theme')">
                    <label for="tech">Policy & Law</label><br>
                    <input type="checkbox" id="tech_check" name="tech" value="tech" onclick="themeClick('Tech','#tech_check','theme')">
                    <label for="tech">Tech. & Innovation</label><br>
                </div>
                <div style="display:inline-block; padding-top:15px; position:absolute;">
                    <input type="checkbox" id="2018_check" name="tech" value="tech" onclick="themeClick(2018,'#2018_check','date')">
                    <label for="tech">2018</label><br>
                    <input type="checkbox" id="2019_check" name="tech" value="tech" onclick="themeClick(2019,'#2019_check','date')">
                    <label for="tech">2019</label><br>
                    <input type="checkbox" id="2020_check" name="tech" value="tech" onclick="themeClick(2020,'#2020_check','date')">
                    <label for="tech">2020</label><br>
                    <input type="checkbox" id="OSU_check" name="tech" value="tech" onclick="themeClick('OSU','#OSU_check','institution')">
                    <label for="tech">OSU</label><br>
                    <input type="checkbox" id="PSU_check" name="tech" value="tech" onclick="themeClick('PSU','#PSU_check','institution')">
                    <label for="tech">PSU</label><br>
                    <input type="checkbox" id="UO_check" name="tech" value="tech" onclick="themeClick('UO','#UO_check','institution')">
                    <label for="tech">UofO</label><br>
                </div>
                <button id="advSearch" style="position:relative; display:block; padding-left:15px;" onclick="advSearch()">Close</button>
            </div>
            <!--<button style="margin-left:5px;" onclick="reset()">Reset</button>-->
            <!--<button onclick="search()">Search</button>-->
            <datalist id="searchList"></datalist>
        </div>
        <div id="panel" class="col-xs-12 col-sm-12 col-md-3" style="padding-left: 0; z-index:1; padding-right:0; margin-top:180px;">
            <div id="scrollbar" style="padding:10px;">
                <div id ="overall" style="padding:5px;"></div>   
                <div id="projects"></div>
            </div>
        </div>
        
        <div class="col-xs-12 col-sm-12 col-md-9" style="margin-bottom: 25px; height:100%; display:block; padding:0;">
            <div id="map" style="z-index:0; ">
                <button type="button" class='centerMap' onclick="addBasins()" id="borderToggle" >Toggle Basins</button>
            </div>
        </div>
    </div>

    </div>
    <script type="text/javascript" src="https://npmcdn.com/csv2geojson@5.1.1/csv2geojson.js"></script>
    <script>
        L.TopoJSON = L.GeoJSON.extend({  
            addData: function(jsonData) {    
                if (jsonData.type === 'Topology') {
                    for (key in jsonData.objects) {
                    geojson = topojson.feature(jsonData, jsonData.objects[key]);
                    L.GeoJSON.prototype.addData.call(this, geojson);
                }
            }    
            else {
                L.GeoJSON.prototype.addData.call(this, jsonData);
                }
            }  
        });
            
        $('input').val('');
        $('input:checkbox').prop('checked', false);

        function advSearch(){
            var display = $('#advancedSearch').css('display');
            if (display == "none")
                $('#advancedSearch').css('display','block');
            if (display == "block")
                $('#advancedSearch').css('display','none');
        }

        function clearSearch(){
            for (var i = 0; i < filter.length; i++){
                filter[i].contents = [];
            }
            $('input').val('');
            $('input:checkbox').prop('checked', false);
            themeClick(null,null,"search");
        }
        
        var container;
        var scrollbarTheme = '#overall';

        var southWest = L.latLng(21.172626315855425, -149.58519708215204),
            northEast = L.latLng(66.10396253416393, -82.34035998361294),
            bounds = L.latLngBounds(southWest, northEast);
        
        var map = L.map('map', {center: [44.20, -120.55], zoom: 7, scrollWheelZoom:false});

        var Esri_sat= L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
            maxZoom:20,
            minZoom:5,
            opacity:1
        });
        
        var Esri_WorldTerrain = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_labels_under/{z}/{x}/{y}{r}.png', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
            maxZoom:20,
            minZoom:5,
            opacity:1
        }).addTo(map);

        var or_cover = L.tileLayer.wms('https://geoserver.library.oregonstate.edu/geoserver/OREGON_WATER/wms', {
            layers: 'OREGON_WATER:oregon_cover',
            format: 'image/png',
            maxZoom:10,
            minZoom:5,
            opacity:0.2,
            transparent:true,
        }).addTo(map);

        var oregonStyle = {
                fillColor: 'black',
                weight: 0,
                opacity: 0,
                fillOpacity:0
            }

        var oregon = $.getJSON('assets/yow/oregon.geojson', function(data){
            oregon = L.geoJson(data, {
                style: oregonStyle,
                interactive:false,
                onEachFeature: function(feature, featureLayer) {
        			//featureLayer.bindTooltip("Statewide", {className: 'statewide_label', permanent:true});
    			}
            }).addTo(map);
        });  

        var basins = new L.TopoJSON(null, {interactive:false});

        $.getJSON('assets/yow/basins.json')
  		    .done(addData);

        function addData(topoData) {  
            basins.addData(topoData);
            basins.eachLayer(handleBasins);
        }

        function handleBasins(layer){
            layer.setStyle({
                    color:'#1D5382',
                    weight:1,
                    opacity: 0.3,
                    fillOpacity:0,
                });
            }

        var theme_points = L.geoJson(null, {
                pointToLayer: function (feature, latlng) {
                    return L.circleMarker(latlng, {
                        color: '#ffffff',
                        fillColor: '#000000',
                        radius: 5,
                        opacity: 1,
                        fillOpacity: 1,
                        weight: 1
                    })//.bindPopup('<h3>' + feature.properties.title_s + '</h3><a target="_blank" href="'+ feature.properties.link +'">Link</a><p>' + feature.properties.desc + '</p>')//<img src="img/' + feature.properties.pic + '.jpg">')
                    .on('click', function(){
                        window.open(feature.properties.link, '_blank');
                    })
                    .bindPopup('<h3>' + feature.properties.title_s + '</h3><p>' + feature.properties.desc + '</p>')//<img src="img/' + feature.properties.pic + '.jpg">')
                    .bindTooltip('<h3>' + feature.properties.title_s + '</h3><p>' + feature.properties.desc + '</p>');//<img src="img/' + feature.properties.pic + '.jpg">');
                }
            });
        
        var runLayer = omnivore.csv('assets/yow/scholars_archive_points.csv', null, theme_points).addTo(map);

        $("input:text").change(function(){
            search();
        });

        var searchValue;
        function search(){
            searchValue=$("input[type=text]#search").val();
            themeClick(null,null,"search");
        }

        var filter = [{
            name: 'theme',
            contents: new Array(),
            variable: 'theme'
        },
        {
            name: 'date',
            contents: new Array(),
            variable: 'date'
        },
        {
            name: 'institution',
            contents: new Array(),
            variable: 'institution'
        }]

        function highlightProject(id){
            var stateHighlight = false;

            theme_points.eachLayer(function (layer) {  
                if(layer.feature.properties.id == id) {    
                    if(layer.feature.properties.geometry == 'FALSE'){
                        $(".statewide_label").css("display","block");
                        oregon.setStyle({fillOpacity:0.5})
                    }
                    layer.setStyle({fillColor :'black', radius:10, weight:2}) 
                }
            });
        }
        function resetProject(id){
            theme_points.eachLayer(function (layer) {  
                if(layer.feature.properties.id == id) {    
                    layer.setStyle({fillColor :'black', radius:5, weight:1}) 
                }
                if(layer.feature.properties.geometry == 'FALSE'){
                    oregon.setStyle({fillOpacity:0})
                    $(".statewide_label").css("display","none");
                }
            });
        }

        function themeClick(theme, check_ID, filter_type){
            var filter_holder;
            //select filter type
            for (var i = 0; i < filter.length; i++){
                if (filter_type == filter[i].name){
                    if ($(check_ID).prop("checked")){
                        filter[i].contents.push(theme.toString());
                    }
                    else{
                        var ind; 
                        for (var j = 0; j < filter[i].contents.length; j++){
                            if (filter[i].contents[j] == theme)
                                ind = j;
                             }
                        filter[i].contents.splice(ind.toString(),1);
                    }
                }         
            }
            
            $("#projects").empty();

            map.removeLayer(theme_points);

            theme_points = L.geoJson(null, {
                pointToLayer: function (feature, latlng) {
                    return L.circleMarker(latlng, {
                        color: '#ffffff',
                        fillColor: '#000000',
                        radius: 5,
                        opacity: 1,
                        fillOpacity: 1,
                        weight: 1
                    }).bindPopup('<h3>' + feature.properties.title_s + '</h3><p>' + feature.properties.desc + '</p>')//<img src="img/' + feature.properties.pic + '.jpg">')
                    .bindTooltip('<h3>' + feature.properties.title_s + '</h3><p>' + feature.properties.desc + '</p>');//<img src="img/' + feature.properties.pic + '.jpg">');
                },
                filter:function(feature,layer){
                        var filter_list = [],
                            props;

                        for (var i = 0; i < filter.length; i++){
                            if (filter[i].contents && filter[i].contents.length > 0){
                                var isFalse = 0;
                                for (var j = 0; j < filter[i].contents.length; j++){
                                    if (feature.properties[filter[i].variable].toLowerCase().includes(filter[i].contents[j].toLowerCase()))
                                        filter_list.push(true);
                                    else 
                                        isFalse++
                                }
                                if (isFalse >= filter[i].contents.length)
                                    filter_list.push(false);                                
                                /*
                                if ($.inArray(feature.properties[filter[i].variable], filter[i].contents) != -1)
                                    filter_list.push(true);
                                else
                                    filter_list.push(false);
                                */
                            }
                        }

                        if (searchValue){
                            if (feature.properties.title_s.toLowerCase().includes(searchValue.toLowerCase()) == true || feature.properties.PI.toLowerCase().includes(searchValue.toLowerCase()) == true)
                                filter_list.push(true);
                            else
                                filter_list.push(false);
                        }

                        if ($.inArray(false, filter_list) == -1){
                            $("#projects").append("<a class='project' target='_blank' id='" + feature.properties.id + "' href='" + feature.properties.linke + "' onmouseover='highlightProject(" + feature.properties.id + ")' ' onmouseout='resetProject(" + feature.properties.id + ")'><div class='project' style='margin-bottom:10px;'><h2 style='margin-bottom:0px; font-weight:bold;'>" + feature.properties.title_s + "</h2><h3 style='margin:5px 5px 5px 0px; font-weight:normal;'>" + feature.properties.PI + "</h3><p>" + feature.properties.desc + "</p></div></a>");
                            return true;       
                        }
                    }
                });

                runLayer = omnivore.csv('assets/yow/scholars_archive_points.csv', null, theme_points).addTo(map);

                resizeMap();

        }

        var dataTable = {};
        function doStuff(data) {
            for (var i = 0;i in data;i++){
                $("#searchList").append($("<option>").attr('value', data[i].title_s));
                $("#searchList").append($("<option>").attr('value', data[i].PI));
                $("#searchList").append($("<option>").attr('value', data[i].co_PIs));
            }
        }

        function parseData(url, callBack) {
            Papa.parse(url, {
                download: true,
                header:true,
                dynamicTyping: true,
                complete: function(results) {
                    callBack(results.data);
                }
            });
        }

        parseData("assets/yow/scholars_archive_points.csv", doStuff); 

        function addBasins() {
            if ($('#borderToggle').prop( "value") == 'selected'){
                map.removeLayer(basins);
                $('#borderToggle').prop( "value","deselected");
            }
            else {
                basins.addTo(map);
                $('#borderToggle').prop( "value","selected");
            }
        } 

        function resizeMap(){
            if ($(window).width() <= 768){
                if ($("#scrollbar").height() > $("#panel").height()){
                    var h = $("#scrollbar").height() - $("#panel").height() + 20;
                    $("#map").css("top",h + "px");
                }
                else{
                    var h = $("#projects").height() + 200;
                    $("#map").css("top", h + "px");
                }
                //console.log("Scrollbar: " + $("#scrollbar").height() + " Panel: " + $("#panel").height() + " Projects: " + $("#projects").height() + " Top: " + h)
            }
            else{
                //$(".project_image").css('height','auto');
                $("#map").css("top","120px");
            }
        }

        $(document).ready(resizeMap);
        $(window).resize(resizeMap);
	
    </script>

</body>

</html>
